version: '3.9'
services:
  bootstrap:
    image: 'alpine'
    volumes:
      - ./conf.json:/tmp/skeleton-conf.json:ro,Z
      - conf-rendered:/etc/product-api:rw
    command: >
      sh -c "apk add jq && jq \"{ \\\"db_connection\\\": \\\"host=product-db port=5432 user=postgres password=${HASHICUPS_DB_PASSWORD:-"password"} dbname=products sslmode=disable\\\" } + .\" < /tmp/skeleton-conf.json > /etc/product-api/conf.json"
  frontend:
    image: 'hashicorpdemoapp/frontend:v1.0.4'
    environment:
      - NEXT_PUBLIC_PUBLIC_API_URL=/
      - NEXT_PUBLIC_FOOTER_FLAG=HashiCups
  nginx:
    image: nginx:alpine
    links:
      - 'public-api:public-api'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro,Z
    ports:
      - 80:80
  public-api:
    image: 'hashicorpdemoapp/public-api:v0.0.7'
    environment:
      - PRODUCT_API_URI=http://product-api:9090
      - PAYMENT_API_URI=http://payments:8080
    links:
      - 'product-api:product-api'
      - 'payments:payments'
    ports:
      - '8080:8080'
  product-api:
    environment:
    - CONFIG_FILE=/etc/product-api/conf.json
    image: 'hashicorpdemoapp/product-api:v0.0.22'
    volumes:
    - conf-rendered:/etc/product-api:ro
    links:
      - 'product-db:product-db'
    ports:
      - '9090:9090'
    depends_on:
      bootstrap:
        condition: service_completed_successfully
  product-db:
    image: 'hashicorpdemoapp/product-api-db:v0.0.22'
    ports:
      - '5432:5432'
    environment:
      - POSTGRES_DB=products
      - POSTGRES_PASSWORD=${HASHICUPS_DB_PASSWORD:-password}
      - POSTGRES_USER=postgres
  payments:
    image: 'hashicorpdemoapp/payments:v0.0.16'
volumes:
  conf-rendered:
